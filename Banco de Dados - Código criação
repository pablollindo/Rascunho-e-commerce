-- Criar banco de dados
CREATE DATABASE pgs_store;
USE pgs_store;

-- Tabela de usuários
CREATE TABLE usuarios (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    senha VARCHAR(255) NOT NULL,
    tipo ENUM('cliente','admin') DEFAULT 'cliente',
    data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ativo BOOLEAN DEFAULT TRUE
);

-- Tabela de plataformas
CREATE TABLE plataformas (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(50) NOT NULL,
    icone VARCHAR(100),
    ativa BOOLEAN DEFAULT TRUE
);

-- Tabela de regiões
CREATE TABLE regioes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(50) NOT NULL,
    codigo VARCHAR(10),
    bandeira VARCHAR(100)
);

-- Tabela de categorias
CREATE TABLE categorias (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(50) NOT NULL,
    descricao TEXT
);

-- Tabela de distribuidoras
CREATE TABLE distribuidoras (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    logo VARCHAR(255)
);

-- Tabela de jogos
CREATE TABLE jogos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    descricao TEXT,
    desenvolvedora VARCHAR(100),
    distribuidora_id INT,
    data_lancamento DATE,
    classificacao_indicativa VARCHAR(10),
    capa_imagem VARCHAR(255),
    trailer_url VARCHAR(255),
    requisitos_minimos TEXT,
    requisitos_recomendados TEXT,
    em_destaque BOOLEAN DEFAULT FALSE,
    ativo BOOLEAN DEFAULT TRUE,
    data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (distribuidora_id) REFERENCES distribuidoras(id)
);

-- Tabela de jogos_plataformas (preços por plataforma)
CREATE TABLE jogos_plataformas (
    id INT AUTO_INCREMENT PRIMARY KEY,
    jogo_id INT,
    plataforma_id INT,
    preco_base DECIMAL(10,2) NOT NULL,
    preco_promocional DECIMAL(10,2),
    em_promocao BOOLEAN DEFAULT FALSE,
    estoque INT DEFAULT 0,
    FOREIGN KEY (jogo_id) REFERENCES jogos(id),
    FOREIGN KEY (plataforma_id) REFERENCES plataformas(id)
);

-- Tabela de chaves digitais
CREATE TABLE chaves_digitais (
    id INT AUTO_INCREMENT PRIMARY KEY,
    jogo_id INT,
    plataforma_id INT,
    regiao_id INT,
    chave VARCHAR(255) UNIQUE NOT NULL,
    utilizada BOOLEAN DEFAULT FALSE,
    data_adicao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (jogo_id) REFERENCES jogos(id),
    FOREIGN KEY (plataforma_id) REFERENCES plataformas(id),
    FOREIGN KEY (regiao_id) REFERENCES regioes(id)
);

-- Tabela de pedidos
CREATE TABLE pedidos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    cliente_id INT,
    total DECIMAL(10,2) NOT NULL,
    status ENUM('pendente','pago','concluido','cancelado') DEFAULT 'pendente',
    metodo_pagamento ENUM('cartao','pix','boleto'),
    data_pedido TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_pagamento TIMESTAMP NULL,
    FOREIGN KEY (cliente_id) REFERENCES usuarios(id)
);

-- Tabela de itens do pedido
CREATE TABLE itens_pedido (
    id INT AUTO_INCREMENT PRIMARY KEY,
    pedido_id INT,
    jogo_id INT,
    plataforma_id INT,
    regiao_id INT,
    chave_digital_id INT,
    preco_unitario DECIMAL(10,2) NOT NULL,
    chave_utilizada BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (pedido_id) REFERENCES pedidos(id),
    FOREIGN KEY (jogo_id) REFERENCES jogos(id),
    FOREIGN KEY (plataforma_id) REFERENCES plataformas(id),
    FOREIGN KEY (regiao_id) REFERENCES regioes(id),
    FOREIGN KEY (chave_digital_id) REFERENCES chaves_digitais(id)
);

-- Tabela de avaliações
CREATE TABLE avaliacoes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    jogo_id INT,
    usuario_id INT,
    nota INT CHECK (nota >= 1 AND nota <= 5),
    comentario TEXT,
    data_avaliacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (jogo_id) REFERENCES jogos(id),
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- Tabela de tickets de suporte
CREATE TABLE tickets_suporte (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT,
    assunto VARCHAR(200) NOT NULL,
    categoria ENUM('compra','jogos','login','chaves','sugestao','outros') NOT NULL,
    descricao TEXT NOT NULL,
    status ENUM('aberto','em_andamento','respondido','fechado') DEFAULT 'aberto',
    prioridade ENUM('baixa','media','alta','urgente') DEFAULT 'media',
    data_abertura TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_ultima_resposta TIMESTAMP NULL,
    data_fechamento TIMESTAMP NULL,
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- Tabela de mensagens do suporte
CREATE TABLE mensagens_suporte (
    id INT AUTO_INCREMENT PRIMARY KEY,
    ticket_id INT,
    usuario_id INT,
    mensagem TEXT NOT NULL,
    data_envio TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    eh_admin BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (ticket_id) REFERENCES tickets_suporte(id),
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- Tabela de FAQ
CREATE TABLE faq (
    id INT AUTO_INCREMENT PRIMARY KEY,
    pergunta VARCHAR(255) NOT NULL,
    resposta TEXT NOT NULL,
    categoria ENUM('compra','jogos','conta','chaves','pagamento') NOT NULL,
    ordem INT DEFAULT 0,
    ativo BOOLEAN DEFAULT TRUE
);

-- Índices para performance
CREATE INDEX idx_jogos_destaque ON jogos(em_destaque, ativo);
CREATE INDEX idx_jogos_plataformas_preco ON jogos_plataformas(preco_base, em_promocao);
CREATE INDEX idx_chaves_utilizadas ON chaves_digitais(utilizada, jogo_id, plataforma_id);
CREATE INDEX idx_pedidos_status ON pedidos(status, data_pedido);
CREATE INDEX idx_tickets_status ON tickets_suporte(status, data_abertura);

-- Dados iniciais
INSERT INTO plataformas (nome, icone) VALUES 
('PC', 'pc.png'),
('PlayStation 4', 'ps4.png'),
('PlayStation 5', 'ps5.png'),
('Xbox One', 'xbox-one.png'),
('Xbox Series X/S', 'xbox-series.png'),
('Nintendo Switch', 'switch.png');

INSERT INTO regioes (nome, codigo, bandeira) VALUES 
('Global', 'GLOBAL', 'global.png'),
('América Latina', 'LATAM', 'latam.png'),
('Europa', 'EU', 'europe.png'),
('Estados Unidos', 'US', 'usa.png'),
('Brasil', 'BR', 'brazil.png');

INSERT INTO categorias (nome, descricao) VALUES 
('Ação', 'Jogos de ação e aventura'),
('Aventura', 'Explore mundos fantásticos'),
('RPG', 'Jogos de role-playing'),
('Estratégia', 'Jogos de estratégia e tática'),
('Esportes', 'Simuladores esportivos'),
('Tiro', 'Jogos de tiro em primeira pessoa'),
('Indie', 'Jogos independentes'),
('Simulação', 'Jogos de simulação realista');

INSERT INTO distribuidoras (nome, logo) VALUES 
('CD Projekt Red', 'cdprojekt.png'),
('Electronic Arts', 'ea.png'),
('Valve', 'valve.png'),
('FromSoftware', 'fromsoftware.png'),
('Rockstar Games', 'rockstar.png'),
('Nintendo', 'nintendo.png'),
('Microsoft', 'microsoft.png'),
('Ubisoft', 'ubisoft.png');

INSERT INTO usuarios (nome, email, senha, tipo, ativo) VALUES 
('Administrador', 'admin@pgsstore.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'admin', TRUE),
('João Silva', 'cliente@email.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'cliente', TRUE);

-- Inserir jogos de exemplo
INSERT INTO jogos (nome, descricao, desenvolvedora, distribuidora_id, data_lancamento, classificacao_indicativa, capa_imagem, trailer_url, requisitos_minimos, requisitos_recomendados, em_destaque) VALUES
('Cyberpunk 2077', 'RPG de ação em mundo aberto no futurista Night City', 'CD Projekt Red', 1, '2020-12-10', '18+', 'cyberpunk.jpg', 'https://youtube.com/cyberpunk', 'Windows 7, Intel i5, 8GB RAM, GTX 780', 'Windows 10, Intel i7, 16GB RAM, RTX 2060', TRUE),
('The Witcher 3: Wild Hunt', 'RPG de fantasia com mundo aberto e histórias épicas', 'CD Projekt Red', 1, '2015-05-19', '18+', 'witcher3.jpg', 'https://youtube.com/witcher3', 'Windows 7, Intel i5, 6GB RAM, GTX 660', 'Windows 10, Intel i7, 8GB RAM, GTX 770', TRUE),
('Elden Ring', 'RPG de ação em mundo aberto com combate desafiador', 'FromSoftware', 4, '2022-02-25', '16+', 'eldenring.jpg', 'https://youtube.com/eldenring', 'Windows 10, Intel i5, 12GB RAM, GTX 1060', 'Windows 10, Intel i7, 16GB RAM, RTX 2070', TRUE),
('Counter-Strike 2', 'Jogo de tiro tático multiplayer', 'Valve', 3, '2023-09-27', '18+', 'cs2.jpg', 'https://youtube.com/cs2', 'Windows 10, 4GB RAM, DirectX 11', 'Windows 10, 8GB RAM, GTX 1060', TRUE);

-- Inserir preços por plataforma
INSERT INTO jogos_plataformas (jogo_id, plataforma_id, preco_base, preco_promocional, em_promocao, estoque) VALUES
-- Cyberpunk 2077
(1, 1, 199.90, 149.90, TRUE, 50),   -- PC
(1, 3, 299.90, 249.90, TRUE, 25),   -- PS5
(1, 5, 279.90, 229.90, TRUE, 20),   -- Xbox Series

-- The Witcher 3
(2, 1, 79.90, 39.90, TRUE, 100),    -- PC
(2, 2, 99.90, 59.90, TRUE, 60),     -- PS4
(2, 6, 119.90, 79.90, TRUE, 40),    -- Switch

-- Elden Ring
(3, 1, 249.90, 199.90, TRUE, 30),   -- PC
(3, 3, 349.90, 299.90, TRUE, 25),   -- PS5

-- Counter-Strike 2
(4, 1, 0.00, 0.00, FALSE, 999);     -- PC (Free)

-- Inserir chaves digitais
INSERT INTO chaves_digitais (jogo_id, plataforma_id, regiao_id, chave) VALUES
(1, 1, 1, 'CP77-GLOBAL-12345-67890'), (1, 1, 2, 'CP77-LATAM-11111-22222'),
(2, 1, 1, 'WITCHER3-GLOBAL-55555'), (2, 1, 2, 'WITCHER3-LATAM-77777'),
(3, 1, 1, 'ELDEN-RING-99999'), (3, 1, 2, 'ELDEN-RING-11111'),
(4, 1, 1, 'CS2-FREE-GLOBAL-55555');

-- Inserir FAQ
INSERT INTO faq (pergunta, resposta, categoria, ordem) VALUES 
('Como recebo minhas chaves?', 'As chaves são entregues automaticamente após a confirmação do pagamento. Acesse em "Minha Biblioteca".', 'compra', 1),
('Quanto tempo leva para receber a chave?', 'Para PIX e cartão: até 5 minutos. Boleto: até 2 dias úteis.', 'compra', 2),
('Quais formas de pagamento?', 'Cartão de crédito, PIX e boleto bancário.', 'pagamento', 1),
('As chaves funcionam em qualquer região?', 'Cada chave tem uma região específica. Chaves Globais funcionam em todo o mundo.', 'chaves', 1),
('Posso reembolsar?', 'Sim, em até 7 dias se a chave não foi usada.', 'jogos', 1);

-- Inserir perguntas prontas para tickets
INSERT INTO faq (pergunta, resposta, categoria, ordem) VALUES 
('Minha chave não funciona', 'Verifique se a região da chave é compatível com sua conta. Se persistir, abra um ticket informando o número do pedido.', 'chaves', 3),
('Não recebi minha chave', 'Aguarde o tempo de processamento. Se passou do prazo, verifique sua biblioteca e spam do email.', 'compra', 3),
('Problema com pagamento', 'Verifique os dados do cartão ou tente outra forma de pagamento. Se foi debitado, aguarde 1h e verifique novamente.', 'pagamento', 2);

SELECT 'Banco de dados PGS Store criado com sucesso!' as status;
