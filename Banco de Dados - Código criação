-- BANCO DE DADOS ATUALIZADO COM SISTEMA DE CARGOS
-- porta do xampp é a 3309

CREATE DATABASE IF NOT EXISTS pgs_perifericos;
USE pgs_perifericos;

-- Tabela de usuários
CREATE TABLE usuarios (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    senha VARCHAR(255) NOT NULL,
    tipo ENUM('cliente','admin','funcionario') DEFAULT 'cliente',
    cpf VARCHAR(14) UNIQUE,
    telefone VARCHAR(15),
    data_nascimento DATE,
    data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ativo BOOLEAN DEFAULT TRUE
);

-- Tabela de funcionários com sistema de cargos ATUALIZADO
CREATE TABLE funcionarios (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT UNIQUE,
    nome VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    senha VARCHAR(255) NOT NULL,
    cargo ENUM('administrador','estoquista','atendente','vendedor','gerente') NOT NULL,
    departamento VARCHAR(50),
    data_admissao DATE NOT NULL,
    data_demissao DATE NULL,
    matricula VARCHAR(50) NULL, -- NOVA COLUNA ADICIONADA
    ativo BOOLEAN DEFAULT TRUE,
    data_criacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- Tabela de categorias
CREATE TABLE categorias (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(50) NOT NULL,
    descricao TEXT,
    ativo BOOLEAN DEFAULT TRUE
);

-- Tabela de marcas
CREATE TABLE marcas (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(50) NOT NULL,
    descricao TEXT,
    site_url VARCHAR(255),
    logo VARCHAR(255),
    ativo BOOLEAN DEFAULT TRUE,
    data_criacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de produtos
CREATE TABLE produtos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    categoria_id INT,
    marca_id INT,
    nome VARCHAR(100) NOT NULL,
    descricao TEXT,
    especificacoes TEXT,
    preco DECIMAL(10,2) NOT NULL,
    preco_promocional DECIMAL(10,2),
    estoque INT DEFAULT 0,
    imagem VARCHAR(255),
    garantia_meses INT DEFAULT 12,
    ativo BOOLEAN DEFAULT TRUE,
    em_destaque BOOLEAN DEFAULT FALSE,
    em_promocao BOOLEAN DEFAULT FALSE,
    data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    media_avaliacoes DECIMAL(3,2) DEFAULT 0.00,
    total_avaliacoes INT DEFAULT 0,
    FOREIGN KEY (categoria_id) REFERENCES categorias(id),
    FOREIGN KEY (marca_id) REFERENCES marcas(id)
);

-- Tabela de endereços dos clientes
CREATE TABLE enderecos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT NOT NULL,
    titulo VARCHAR(50) NOT NULL,
    cep VARCHAR(9) NOT NULL,
    logradouro VARCHAR(200) NOT NULL,
    numero VARCHAR(10) NOT NULL,
    complemento VARCHAR(100),
    bairro VARCHAR(100) NOT NULL,
    cidade VARCHAR(100) NOT NULL,
    estado VARCHAR(2) NOT NULL,
    principal BOOLEAN DEFAULT FALSE,
    data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- Tabela de pedidos
CREATE TABLE pedidos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    cliente_id INT,
    total DECIMAL(10,2) NOT NULL,
    subtotal DECIMAL(10,2) NOT NULL,
    desconto DECIMAL(10,2) DEFAULT 0,
    status ENUM('pendente','pago','processando','enviado','entregue','cancelado') DEFAULT 'pendente',
    metodo_pagamento ENUM('cartao','pix','boleto'),
    numero_cartao VARCHAR(20),
    nome_titular VARCHAR(100),
    data_vencimento DATE,
    codigo_seguranca VARCHAR(4),
    codigo_pix TEXT,
    codigo_boleto VARCHAR(50),
    data_pedido TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_pagamento TIMESTAMP NULL,
    data_envio TIMESTAMP NULL,
    endereco_entrega TEXT,
    FOREIGN KEY (cliente_id) REFERENCES usuarios(id)
);

-- Tabela de itens do pedido
CREATE TABLE itens_pedido (
    id INT AUTO_INCREMENT PRIMARY KEY,
    pedido_id INT,
    produto_id INT,
    quantidade INT DEFAULT 1,
    preco_unitario DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (pedido_id) REFERENCES pedidos(id),
    FOREIGN KEY (produto_id) REFERENCES produtos(id)
);

-- Tabela de avaliações
CREATE TABLE avaliacoes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    produto_id INT NOT NULL,
    usuario_id INT NOT NULL,
    pedido_id INT NOT NULL,
    nota INT NOT NULL CHECK (nota >= 1 AND nota <= 5),
    titulo VARCHAR(200),
    comentario TEXT,
    data_avaliacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    aprovado BOOLEAN DEFAULT TRUE,
    recomendacao ENUM('sim','nao') DEFAULT 'sim',
    FOREIGN KEY (produto_id) REFERENCES produtos(id),
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id),
    FOREIGN KEY (pedido_id) REFERENCES pedidos(id),
    UNIQUE KEY unique_avaliacao (usuario_id, produto_id)
);

-- Tabela de cupons de desconto
CREATE TABLE cupons_desconto (
    id INT AUTO_INCREMENT PRIMARY KEY,
    codigo VARCHAR(50) UNIQUE NOT NULL,
    desconto_percentual DECIMAL(5,2),
    desconto_valor DECIMAL(10,2),
    data_validade DATE,
    usos_maximos INT,
    usos_atuais INT DEFAULT 0,
    ativo BOOLEAN DEFAULT TRUE,
    data_criacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de tickets de suporte
CREATE TABLE tickets_suporte (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT,
    assunto VARCHAR(200) NOT NULL,
    categoria ENUM('compra','produto','garantia','entrega','conta','outros') NOT NULL,
    descricao TEXT NOT NULL,
    status ENUM('aberto','em_andamento','respondido','fechado') DEFAULT 'aberto',
    prioridade ENUM('baixa','media','alta','urgente') DEFAULT 'media',
    data_abertura TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_ultima_resposta TIMESTAMP NULL,
    data_fechamento TIMESTAMP NULL,
    funcionario_responsavel INT NULL,
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id),
    FOREIGN KEY (funcionario_responsavel) REFERENCES funcionarios(id)
);

-- Tabela de mensagens do suporte
CREATE TABLE mensagens_suporte (
    id INT AUTO_INCREMENT PRIMARY KEY,
    ticket_id INT,
    usuario_id INT,
    mensagem TEXT NOT NULL,
    data_envio TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    eh_funcionario BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (ticket_id) REFERENCES tickets_suporte(id),
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- Tabela de FAQ
CREATE TABLE faq (
    id INT AUTO_INCREMENT PRIMARY KEY,
    pergunta VARCHAR(255) NOT NULL,
    resposta TEXT NOT NULL,
    categoria ENUM('compra','produto','garantia','entrega','pagamento') NOT NULL,
    ordem INT DEFAULT 0,
    ativo BOOLEAN DEFAULT TRUE
);

-- Tabela de wishlist
CREATE TABLE wishlist (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT NOT NULL,
    produto_id INT NOT NULL,
    data_adicao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id),
    FOREIGN KEY (produto_id) REFERENCES produtos(id),
    UNIQUE KEY unique_wishlist (usuario_id, produto_id)
);

-- Índices para performance
CREATE INDEX idx_produtos_destaque ON produtos(em_destaque, ativo);
CREATE INDEX idx_produtos_promocao ON produtos(em_promocao, ativo);
CREATE INDEX idx_pedidos_status ON pedidos(status, data_pedido);
CREATE INDEX idx_tickets_status ON tickets_suporte(status, data_abertura);
CREATE INDEX idx_usuarios_email ON usuarios(email);
CREATE INDEX idx_funcionarios_email ON funcionarios(email);
CREATE INDEX idx_produtos_categoria ON produtos(categoria_id);
CREATE INDEX idx_pedidos_cliente ON pedidos(cliente_id);
CREATE INDEX idx_avaliacoes_produto ON avaliacoes(produto_id);
CREATE INDEX idx_avaliacoes_usuario ON avaliacoes(usuario_id);
CREATE INDEX idx_produtos_marca ON produtos(marca_id);
CREATE INDEX idx_marcas_nome ON marcas(nome);
CREATE INDEX idx_wishlist_usuario ON wishlist(usuario_id);

-- Dados iniciais
INSERT INTO categorias (nome, descricao) VALUES 
('Teclados', 'Teclados mecânicos, membrana e gaming'),
('Mouses', 'Mouses gamers, ópticos e sem fio'),
('Headsets', 'Fones de ouvido e headsets gamers'),
('Monitores', 'Monitores gaming e profissionais'),
('Mousepads', 'Mousepads speed e control'),
('Webcams', 'Webcams para streaming e reuniões'),
('Microfones', 'Microfones para streaming e gravação');

-- Inserir marcas populares
INSERT INTO marcas (nome, descricao, site_url) VALUES 
('Redragon', 'Marca especializada em periféricos gamers de alta qualidade', 'https://redragon.com.br'),
('Logitech', 'Líder mundial em periféricos para computador e gaming', 'https://logitech.com'),
('HyperX', 'Marca da Kingston focada em produtos para gaming', 'https://hyperx.com'),
('Dell', 'Fabricante de computadores e periféricos profissionais', 'https://dell.com'),
('Razer', 'Marca premium de periféricos para gaming', 'https://razer.com'),
('Corsair', 'Especialista em componentes e periféricos gamers', 'https://corsair.com'),
('SteelSeries', 'Marca dinamarquesa de equipamentos para gaming', 'https://steelseries.com'),
('ASUS', 'Fabricante de componentes e periféricos gamers ROG', 'https://asus.com');

-- Usuários iniciais (senha: password)
INSERT INTO usuarios (nome, email, senha, tipo, cpf, telefone, data_nascimento) VALUES 
('Administrador Master', 'admin@pgsecommerce.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'admin', '111.222.333-44', '(11) 99999-9999', '1980-01-01'),
('João Estoquista', 'estoque@pgsecommerce.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'funcionario', '222.333.444-55', '(11) 98888-8888', '1985-03-15'),
('Maria Atendente', 'atendimento@pgsecommerce.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'funcionario', '333.444.555-66', '(11) 97777-7777', '1990-07-20'),
('Pedro Vendedor', 'vendas@pgsecommerce.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'funcionario', '444.555.666-77', '(11) 96666-6666', '1988-11-10'),
('Cliente Teste', 'cliente@email.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'cliente', '555.666.777-88', '(11) 95555-5555', '1995-05-25');

-- Funcionários iniciais com cargos ATUALIZADOS (agora com matrícula)
INSERT INTO funcionarios (usuario_id, nome, email, senha, cargo, departamento, data_admissao, matricula) VALUES
(1, 'Administrador Master', 'admin@pgsecommerce.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'administrador', 'Administração', '2023-01-01', 'PG001'),
(2, 'João Estoquista', 'estoque@pgsecommerce.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'estoquista', 'Estoque', '2023-02-15', 'PG002'),
(3, 'Maria Atendente', 'atendimento@pgsecommerce.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'atendente', 'Atendimento', '2023-03-20', 'PG003'),
(4, 'Pedro Vendedor', 'vendas@pgsecommerce.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'vendedor', 'Vendas', '2023-04-10', 'PG004');

-- Produtos
INSERT INTO produtos (categoria_id, marca_id, nome, descricao, especificacoes, preco, preco_promocional, estoque, imagem, garantia_meses, em_destaque, em_promocao) VALUES
(1, 1, 'Teclado Mecânico RGB Kumara', 'Teclado mecânico gaming com iluminação RGB, switches Outemu Blue', 'Switches: Outemu Blue | Layout: ABNT2 | Iluminação: RGB | Conexão: USB | Peso: 1.2kg', 299.90, 249.90, 50, 'teclado-mecanico.jpg', 12, TRUE, TRUE),
(2, 2, 'Mouse Gamer G502 HERO', 'Mouse gaming com sensor HERO 25K DPI, 11 botões programáveis', 'Sensor: HERO 25K DPI | Botões: 11 programáveis | Peso: 121g | Iluminação: RGB | Polling Rate: 1000Hz', 349.90, 299.90, 30, 'mouse-gamer.jpg', 24, TRUE, TRUE),
(3, 3, 'Headset Cloud II', 'Headset gamer com som surround virtual 7.1, microfone removível', 'Driver: 53mm | Impedância: 60Ω | Sensibilidade: 98±3dB | Microfone: Removível com cancelamento de ruído', 399.90, 349.90, 25, 'headset.jpg', 12, TRUE, TRUE),
(4, 4, 'Monitor Gamer 24" S2421H', 'Monitor gaming 24 polegadas, 144Hz, 1ms, FreeSync', 'Tela: 24" IPS | Resolução: 1920x1080 | Taxa de atualização: 144Hz | Tempo de resposta: 1ms | FreeSync', 899.90, 799.90, 15, 'monitor.jpg', 36, TRUE, TRUE),
(5, 6, 'Mousepad MM300', 'Mousepad speed extendido para gaming, antiderrapante', 'Tamanho: 930x300mm | Espessura: 4mm | Superfície: Speed | Base: Antiderrapante | Material: Borracha', 89.90, 69.90, 75, 'mousepad.jpg', 6, FALSE, TRUE);

-- Pedidos de exemplo
INSERT INTO pedidos (cliente_id, total, subtotal, status, metodo_pagamento, data_pedido) VALUES
(5, 649.80, 649.80, 'entregue', 'cartao', '2024-01-15 10:00:00'),
(5, 349.90, 349.90, 'entregue', 'pix', '2024-01-20 14:30:00');

INSERT INTO itens_pedido (pedido_id, produto_id, quantidade, preco_unitario) VALUES
(1, 1, 1, 249.90),
(1, 3, 1, 399.90),
(2, 2, 1, 349.90);

-- Avaliações de exemplo
INSERT INTO avaliacoes (produto_id, usuario_id, pedido_id, nota, titulo, comentario, recomendacao) VALUES
(1, 5, 1, 5, 'Excelente teclado!', 'Teclado muito bom, switches blue são ótimos para digitar. RGB é lindo!', 'sim'),
(3, 5, 1, 4, 'Muito bom, mas...', 'Headset confortável e som excelente. Só o microfone que poderia ser melhor.', 'sim'),
(2, 5, 2, 5, 'Perfeito para jogos!', 'Mouse preciso, botões programáveis muito úteis. Recomendo!', 'sim');

-- Atualizar médias dos produtos
UPDATE produtos SET 
media_avaliacoes = 5.0, 
total_avaliacoes = 1 
WHERE id = 1;

UPDATE produtos SET 
media_avaliacoes = 5.0, 
total_avaliacoes = 1 
WHERE id = 2;

UPDATE produtos SET 
media_avaliacoes = 4.0, 
total_avaliacoes = 1 
WHERE id = 3;

-- Cupons de desconto
INSERT INTO cupons_desconto (codigo, desconto_percentual, data_validade, usos_maximos, ativo) VALUES
('PRIMEIRACOMPRA', 15.00, '2024-12-31', 1000, TRUE),
('PROMO10', 10.00, '2024-06-30', 500, TRUE);

-- FAQ
INSERT INTO faq (pergunta, resposta, categoria, ordem) VALUES 
('Como faço para rastrear meu pedido?', 'Após a confirmação do pagamento, você receberá um código de rastreamento por email.', 'entrega', 1),
('Quais formas de pagamento são aceitas?', 'Aceitamos cartão de crédito (até 12x), PIX (5% off) e boleto bancário.', 'pagamento', 1),
('Como funciona a garantia dos produtos?', 'Todos os produtos possuem garantia do fabricante, que varia de 3 a 12 meses.', 'garantia', 1),
('Posso avaliar um produto?', 'Sim! Após receber seu pedido, você pode avaliar os produtos comprados.', 'produto', 2);

-- Tickets de suporte de exemplo
INSERT INTO tickets_suporte (usuario_id, assunto, categoria, descricao, status, prioridade) VALUES
(5, 'Produto não chegou', 'entrega', 'Comprei um teclado há 15 dias e ainda não recebi.', 'aberto', 'alta'),
(5, 'Dúvida sobre garantia', 'garantia', 'Gostaria de saber como acionar a garantia do meu headset.', 'em_andamento', 'media');

-- Wishlist de exemplo
INSERT INTO wishlist (usuario_id, produto_id) VALUES
(5, 1),
(5, 3);

SELECT 'Banco de dados PGS Periféricos criado com sucesso!' as status;
