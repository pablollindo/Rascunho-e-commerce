-- Criar banco de dados
CREATE DATABASE pgs_store;
USE pgs_store;

-- Tabela de usuários
CREATE TABLE usuarios (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    senha VARCHAR(255) NOT NULL,
    tipo ENUM('cliente','admin') DEFAULT 'cliente',
    data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ultimo_login TIMESTAMP NULL,
    ativo BOOLEAN DEFAULT TRUE
);

-- Tabela de plataformas
CREATE TABLE plataformas (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(50) NOT NULL,
    icone VARCHAR(100),
    ativa BOOLEAN DEFAULT TRUE
);

-- Tabela de regiões
CREATE TABLE regioes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(50) NOT NULL,
    codigo VARCHAR(10),
    bandeira VARCHAR(100)
);

-- Tabela de categorias de jogos
CREATE TABLE categorias (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(50) NOT NULL,
    icone VARCHAR(100),
    cor VARCHAR(7) DEFAULT '#6B7280'
);

-- Tabela de jogos
CREATE TABLE jogos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    descricao TEXT,
    desenvolvedora VARCHAR(100),
    distribuidora VARCHAR(100),
    data_lancamento DATE,
    classificacao_indicativa VARCHAR(10),
    capa_imagem VARCHAR(255),
    trailer_url VARCHAR(255),
    screenshots JSON,
    requisitos_minimos TEXT,
    requisitos_recomendados TEXT,
    tags JSON,
    ativo BOOLEAN DEFAULT TRUE,
    em_destaque BOOLEAN DEFAULT FALSE,
    data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de jogos_plataformas
CREATE TABLE jogos_plataformas (
    id INT AUTO_INCREMENT PRIMARY KEY,
    jogo_id INT,
    plataforma_id INT,
    preco_base DECIMAL(10,2) NOT NULL,
    preco_promocional DECIMAL(10,2),
    em_promocao BOOLEAN DEFAULT FALSE,
    data_inicio_promocao DATE NULL,
    data_fim_promocao DATE NULL,
    estoque INT DEFAULT 0,
    FOREIGN KEY (jogo_id) REFERENCES jogos(id),
    FOREIGN KEY (plataforma_id) REFERENCES plataformas(id)
);

-- Tabela de chaves digitais
CREATE TABLE chaves_digitais (
    id INT AUTO_INCREMENT PRIMARY KEY,
    jogo_id INT,
    plataforma_id INT,
    regiao_id INT,
    chave VARCHAR(255) UNIQUE NOT NULL,
    utilizada BOOLEAN DEFAULT FALSE,
    data_compra TIMESTAMP NULL,
    pedido_id INT NULL,
    data_ativacao TIMESTAMP NULL,
    data_adicao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (jogo_id) REFERENCES jogos(id),
    FOREIGN KEY (plataforma_id) REFERENCES plataformas(id),
    FOREIGN KEY (regiao_id) REFERENCES regioes(id)
);

-- Tabela de pedidos
CREATE TABLE pedidos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    cliente_id INT,
    total DECIMAL(10,2) NOT NULL,
    subtotal DECIMAL(10,2) NOT NULL,
    desconto DECIMAL(10,2) DEFAULT 0,
    status ENUM('pendente','pago','processando','concluido','cancelado') DEFAULT 'pendente',
    metodo_pagamento ENUM('cartao','pix','boleto','paypal'),
    data_pedido TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_pagamento TIMESTAMP NULL,
    data_conclusao TIMESTAMP NULL,
    codigo_transacao VARCHAR(100),
    codigo_pix TEXT,
    codigo_boleto VARCHAR(100),
    FOREIGN KEY (cliente_id) REFERENCES usuarios(id)
);

-- Tabela de itens do pedido
CREATE TABLE itens_pedido (
    id INT AUTO_INCREMENT PRIMARY KEY,
    pedido_id INT,
    jogo_id INT,
    plataforma_id INT,
    regiao_id INT,
    chave_digital_id INT,
    quantidade INT DEFAULT 1,
    preco_unitario DECIMAL(10,2) NOT NULL,
    chave_utilizada BOOLEAN DEFAULT FALSE,
    data_utilizacao TIMESTAMP NULL,
    FOREIGN KEY (pedido_id) REFERENCES pedidos(id),
    FOREIGN KEY (jogo_id) REFERENCES jogos(id),
    FOREIGN KEY (plataforma_id) REFERENCES plataformas(id),
    FOREIGN KEY (regiao_id) REFERENCES regioes(id),
    FOREIGN KEY (chave_digital_id) REFERENCES chaves_digitais(id)
);

-- Tabela de cupons de desconto
CREATE TABLE cupons_desconto (
    id INT AUTO_INCREMENT PRIMARY KEY,
    codigo VARCHAR(50) UNIQUE NOT NULL,
    desconto_percentual DECIMAL(5,2),
    desconto_valor DECIMAL(10,2),
    data_validade DATE,
    usos_maximos INT,
    usos_atuais INT DEFAULT 0,
    ativo BOOLEAN DEFAULT TRUE,
    data_criacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de avaliações
CREATE TABLE avaliacoes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    jogo_id INT,
    usuario_id INT,
    nota INT CHECK (nota >= 1 AND nota <= 5),
    comentario TEXT,
    data_avaliacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    aprovada BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (jogo_id) REFERENCES jogos(id),
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- Tabela de tickets de suporte
CREATE TABLE tickets_suporte (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT,
    assunto VARCHAR(200) NOT NULL,
    categoria ENUM('compra','jogos','login','chaves','sugestao','outros') NOT NULL,
    descricao TEXT NOT NULL,
    status ENUM('aberto','em_andamento','respondido','fechado') DEFAULT 'aberto',
    prioridade ENUM('baixa','media','alta','urgente') DEFAULT 'media',
    data_abertura TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_ultima_resposta TIMESTAMP NULL,
    data_fechamento TIMESTAMP NULL,
    admin_responsavel INT NULL,
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id),
    FOREIGN KEY (admin_responsavel) REFERENCES usuarios(id)
);

-- Tabela de mensagens do suporte
CREATE TABLE mensagens_suporte (
    id INT AUTO_INCREMENT PRIMARY KEY,
    ticket_id INT,
    usuario_id INT,
    mensagem TEXT NOT NULL,
    anexo VARCHAR(255) NULL,
    data_envio TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    eh_admin BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (ticket_id) REFERENCES tickets_suporte(id),
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- Tabela de FAQ
CREATE TABLE faq (
    id INT AUTO_INCREMENT PRIMARY KEY,
    pergunta VARCHAR(255) NOT NULL,
    resposta TEXT NOT NULL,
    categoria ENUM('compra','jogos','conta','chaves','pagamento') NOT NULL,
    ordem INT DEFAULT 0,
    ativo BOOLEAN DEFAULT TRUE
);

-- Índices para melhor performance
CREATE INDEX idx_jogos_destaque ON jogos(em_destaque, ativo);
CREATE INDEX idx_jogos_plataformas_promocao ON jogos_plataformas(em_promocao, data_fim_promocao);
CREATE INDEX idx_chaves_utilizadas ON chaves_digitais(utilizada, jogo_id, plataforma_id);
CREATE INDEX idx_pedidos_status ON pedidos(status, data_pedido);
CREATE INDEX idx_tickets_status ON tickets_suporte(status, prioridade, data_abertura);
CREATE INDEX idx_faq_categoria ON faq(categoria, ordem, ativo);

-- Dados iniciais
INSERT INTO plataformas (nome, icone, ativa) VALUES 
('PC', 'pc.png', TRUE),
('PlayStation 4', 'ps4.png', TRUE),
('PlayStation 5', 'ps5.png', TRUE),
('Xbox One', 'xbox-one.png', TRUE),
('Xbox Series X/S', 'xbox-series.png', TRUE),
('Nintendo Switch', 'switch.png', TRUE);

INSERT INTO regioes (nome, codigo, bandeira) VALUES 
('Global', 'GLOBAL', 'global.png'),
('América Latina', 'LATAM', 'latam.png'),
('Europa', 'EU', 'europe.png'),
('Estados Unidos', 'US', 'usa.png'),
('Brasil', 'BR', 'brazil.png'),
('Asia', 'ASIA', 'asia.png');

INSERT INTO categorias (nome, icone, cor) VALUES 
('Ação', 'sword.png', '#EF4444'),
('Aventura', 'compass.png', '#10B981'),
('RPG', 'dragon.png', '#8B5CF6'),
('Estratégia', 'chess.png', '#F59E0B'),
('Esportes', 'soccer.png', '#06B6D4'),
('Corrida', 'racing-car.png', '#DC2626'),
('Tiro', 'gun.png', '#6B7280'),
('Indie', 'indie.png', '#EC4899'),
('Simulação', 'simulation.png', '#059669'),
('Luta', 'boxing.png', '#EA580C');

INSERT INTO usuarios (nome, email, senha, tipo, ativo) VALUES 
('Administrador PGS', 'admin@pgsstore.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'admin', TRUE);

-- Inserir FAQ inicial
INSERT INTO faq (pergunta, resposta, categoria, ordem, ativo) VALUES 
('Como recebo minhas chaves de jogos?', 'As chaves são entregues instantaneamente após a confirmação do pagamento. Você pode acessá-las em "Minha Biblioteca" na sua conta.', 'compra', 1, TRUE),
('Quanto tempo leva para a chave ficar disponível?', 'Para pagamentos via PIX e cartão, a chave é liberada em até 5 minutos. Para boleto, pode levar até 2 dias úteis após o pagamento.', 'compra', 2, TRUE),
('Quais formas de pagamento são aceitas?', 'Aceitamos cartão de crédito (todas as bandeiras), PIX, boleto bancário e PayPal.', 'pagamento', 1, TRUE),
('O pagamento é seguro?', 'Sim, utilizamos sistema de pagamento criptografado e não armazenamos dados do seu cartão em nossos servidores.', 'pagamento', 2, TRUE),
('As chaves funcionam em qualquer região?', 'Cada chave possui uma região específica. Verifique a compatibilidade da região antes da compra. Chaves Globais funcionam em todas as regiões.', 'chaves', 1, TRUE),
('O que fazer se a chave não funcionar?', Entre em contato conosco através do sistema de suporte informando o número do pedido e a chave que não funcionou. Resolveremos em até 24h.', 'chaves', 2, TRUE),
('Posso reembolsar um jogo?', 'Sim, oferecemos reembolso em até 7 dias após a compra, desde que a chave não tenha sido utilizada.', 'jogos', 1, TRUE),
('Como altero minha senha?', 'Vá em "Minha Conta" > "Alterar Senha" ou use a opção "Esqueci minha senha" na página de login.', 'conta', 1, TRUE),
('Posso transferir um jogo para outra conta?', 'Não, as chaves são vinculadas à conta onde foram compradas e não podem ser transferidas.', 'conta', 2, TRUE),
('O site é confiável?', 'Sim, somos uma loja oficial com anos no mercado e milhares de clientes satisfeitos. Todos os nossos produtos são originais.', 'compra', 3, TRUE);

-- Inserir jogos de exemplo
INSERT INTO jogos (nome, descricao, desenvolvedora, distribuidora, data_lancamento, classificacao_indicativa, em_destaque, tags) VALUES
('Cyberpunk 2077', 'Um RPG de ação e aventura em mundo aberto ambientado em Night City, uma metrópole obcecada por poder, glamour e modificações corporais.', 'CD Projekt Red', 'CD Projekt', '2020-12-10', '18+', TRUE, '["RPG", "Ação", "Mundo Aberto", "Futurista"]'),
('The Witcher 3: Wild Hunt', 'RPG de mundo aberto de fantasia cheio de escolhas consequentes e missões impactantes.', 'CD Projekt Red', 'CD Projekt', '2015-05-19', '18+', TRUE, '["RPG", "Fantasia", "Mundo Aberto", "Aventura"]'),
('FIFA 23', 'O mais completo jogo de futebol com os maiores times e ligas do mundo.', 'EA Sports', 'Electronic Arts', '2022-09-30', 'L', FALSE, '["Esportes", "Futebol", "Multijogador"]'),
('Counter-Strike 2', 'Clássico jogo de tiro em primeira pessoa com modo competitivo online.', 'Valve', 'Valve', '2023-09-27', '18+', TRUE, '["Tiro", "Multijogador", "Competitivo"]');

-- Inserir preços por plataforma
INSERT INTO jogos_plataformas (jogo_id, plataforma_id, preco_base, preco_promocional, em_promocao, estoque) VALUES
-- Cyberpunk 2077
(1, 1, 199.90, 149.90, TRUE, 50),   -- PC com promoção
(1, 2, 249.90, NULL, FALSE, 30),    -- PS4 sem promoção
(1, 3, 299.90, 249.90, TRUE, 25),   -- PS5 com promoção
(1, 4, 229.90, 179.90, TRUE, 20),   -- Xbox One com promoção

-- The Witcher 3
(2, 1, 79.90, 39.90, TRUE, 100),
(2, 2, 99.90, 59.90, TRUE, 60),
(2, 3, 119.90, 79.90, TRUE, 40),

-- FIFA 23
(3, 1, 249.90, 199.90, TRUE, 80),
(3, 2, 299.90, NULL, FALSE, 50),
(3, 4, 299.90, 249.90, TRUE, 45),

-- Counter-Strike 2
(4, 1, 0.00, 0.00, FALSE, 999);     -- Free to play

-- Inserir chaves digitais de exemplo
INSERT INTO chaves_digitais (jogo_id, plataforma_id, regiao_id, chave) VALUES
-- Cyberpunk 2077 - PC
(1, 1, 1, 'CP77-GLOBAL-12345-67890-ABCDE'),
(1, 1, 1, 'CP77-GLOBAL-54321-09876-FGHIJ'),
(1, 1, 2, 'CP77-LATAM-11111-22222-KLMNO'),
(1, 1, 2, 'CP77-LATAM-33333-44444-PQRST'),

-- The Witcher 3 - PC
(2, 1, 1, 'WITCHER3-GLOBAL-55555-66666'),
(2, 1, 1, 'WITCHER3-GLOBAL-77777-88888'),

-- FIFA 23 - PC
(3, 1, 2, 'FIFA23-LATAM-99999-00000'),
(3, 1, 2, 'FIFA23-LATAM-11111-22222');

-- Inserir cupons de desconto exemplo
INSERT INTO cupons_desconto (codigo, desconto_percentual, desconto_valor, data_validade, usos_maximos, ativo) VALUES
('PRIMEIRACOMPRA', 15.00, NULL, '2024-12-31', 1000, TRUE),
('PROMO10', 10.00, NULL, '2024-06-30', 500, TRUE),
('LANCAMENTO', 5.00, NULL, '2024-03-31', 200, TRUE);

-- Mensagem de sucesso
SELECT 'Banco de dados PGS Store criado com sucesso!' as status;