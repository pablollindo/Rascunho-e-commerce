-- Criar banco de dados
CREATE DATABASE pgs_perifericos;
USE pgs_perifericos;

-- Tabela de usuários
CREATE TABLE usuarios (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    senha VARCHAR(255) NOT NULL,
    tipo ENUM('cliente','admin') DEFAULT 'cliente',
    data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de categorias
CREATE TABLE categorias (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(50) NOT NULL,
    descricao TEXT
);

-- Tabela de produtos
CREATE TABLE produtos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    categoria_id INT,
    nome VARCHAR(100) NOT NULL,
    descricao TEXT,
    preco DECIMAL(10,2) NOT NULL,
    preco_promocional DECIMAL(10,2),
    estoque INT DEFAULT 0,
    imagem VARCHAR(255),
    ativo BOOLEAN DEFAULT TRUE,
    em_destaque BOOLEAN DEFAULT FALSE,
    em_promocao BOOLEAN DEFAULT FALSE,
    data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (categoria_id) REFERENCES categorias(id)
);

-- Tabela de pedidos
CREATE TABLE pedidos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    cliente_id INT,
    total DECIMAL(10,2) NOT NULL,
    subtotal DECIMAL(10,2) NOT NULL,
    desconto DECIMAL(10,2) DEFAULT 0,
    status ENUM('pendente','pago','processando','enviado','entregue','cancelado') DEFAULT 'pendente',
    metodo_pagamento ENUM('cartao','pix','boleto'),
    data_pedido TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_pagamento TIMESTAMP NULL,
    data_envio TIMESTAMP NULL,
    FOREIGN KEY (cliente_id) REFERENCES usuarios(id)
);

-- Tabela de itens do pedido
CREATE TABLE itens_pedido (
    id INT AUTO_INCREMENT PRIMARY KEY,
    pedido_id INT,
    produto_id INT,
    quantidade INT DEFAULT 1,
    preco_unitario DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (pedido_id) REFERENCES pedidos(id),
    FOREIGN KEY (produto_id) REFERENCES produtos(id)
);

-- Tabela de cupons de desconto
CREATE TABLE cupons_desconto (
    id INT AUTO_INCREMENT PRIMARY KEY,
    codigo VARCHAR(50) UNIQUE NOT NULL,
    desconto_percentual DECIMAL(5,2),
    desconto_valor DECIMAL(10,2),
    data_validade DATE,
    usos_maximos INT,
    usos_atuais INT DEFAULT 0,
    ativo BOOLEAN DEFAULT TRUE,
    data_criacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de avaliações
CREATE TABLE avaliacoes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    produto_id INT,
    usuario_id INT,
    nota INT CHECK (nota >= 1 AND nota <= 5),
    comentario TEXT,
    data_avaliacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (produto_id) REFERENCES produtos(id),
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- Tabela de tickets de suporte
CREATE TABLE tickets_suporte (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT,
    assunto VARCHAR(200) NOT NULL,
    categoria ENUM('compra','produto','garantia','entrega','conta','outros') NOT NULL,
    descricao TEXT NOT NULL,
    status ENUM('aberto','em_andamento','respondido','fechado') DEFAULT 'aberto',
    prioridade ENUM('baixa','media','alta','urgente') DEFAULT 'media',
    data_abertura TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_ultima_resposta TIMESTAMP NULL,
    data_fechamento TIMESTAMP NULL,
    admin_responsavel INT NULL,
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id),
    FOREIGN KEY (admin_responsavel) REFERENCES usuarios(id)
);

-- Tabela de mensagens do suporte
CREATE TABLE mensagens_suporte (
    id INT AUTO_INCREMENT PRIMARY KEY,
    ticket_id INT,
    usuario_id INT,
    mensagem TEXT NOT NULL,
    data_envio TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    eh_admin BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (ticket_id) REFERENCES tickets_suporte(id),
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- Tabela de FAQ
CREATE TABLE faq (
    id INT AUTO_INCREMENT PRIMARY KEY,
    pergunta VARCHAR(255) NOT NULL,
    resposta TEXT NOT NULL,
    categoria ENUM('compra','produto','garantia','entrega','pagamento') NOT NULL,
    ordem INT DEFAULT 0,
    ativo BOOLEAN DEFAULT TRUE
);

-- Índices para performance
CREATE INDEX idx_produtos_destaque ON produtos(em_destaque, ativo);
CREATE INDEX idx_produtos_promocao ON produtos(em_promocao, ativo);
CREATE INDEX idx_pedidos_status ON pedidos(status, data_pedido);
CREATE INDEX idx_tickets_status ON tickets_suporte(status, data_abertura);

-- Dados iniciais
INSERT INTO categorias (nome, descricao) VALUES 
('Teclados', 'Teclados mecânicos, membrana e gaming'),
('Mouses', 'Mouses gamers, ópticos e sem fio'),
('Headsets', 'Fones de ouvido e headsets gamers'),
('Monitores', 'Monitores gaming e profissionais'),
('Mousepads', 'Mousepads speed e control'),
('Webcams', 'Webcams para streaming e reuniões');

INSERT INTO usuarios (nome, email, senha, tipo) VALUES 
('Administrador', 'admin@pgsperifericos.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'admin'),
('João Silva', 'cliente@email.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'cliente');

INSERT INTO produtos (categoria_id, nome, descricao, preco, preco_promocional, estoque, imagem, em_destaque, em_promocao) VALUES
(1, 'Teclado Mecânico RGB Redragon', 'Teclado mecânico gaming com iluminação RGB, switches Outemu Blue', 299.90, 249.90, 50, 'teclado-mecanico.jpg', TRUE, TRUE),
(2, 'Mouse Gamer Logitech G502', 'Mouse gaming com sensor HERO 25K DPI, 11 botões programáveis', 349.90, NULL, 30, 'mouse-gamer.jpg', TRUE, FALSE),
(3, 'Headset HyperX Cloud II', 'Headset gamer com som surround virtual 7.1, microfone removível', 399.90, 349.90, 25, 'headset.jpg', TRUE, TRUE),
(4, 'Monitor Gamer 24" 144Hz', 'Monitor gaming 24 polegadas, 144Hz, 1ms, FreeSync', 899.90, 799.90, 15, 'monitor.jpg', FALSE, TRUE),
(1, 'Teclado Membrana Logitech', 'Teclado de membrana silencioso, design slim, multimídia', 129.90, NULL, 80, 'teclado-membrana.jpg', FALSE, FALSE),
(2, 'Mouse Sem Fio Dell', 'Mouse óptico sem fio, 1600 DPI, bateria de longa duração', 79.90, 59.90, 100, 'mouse-sem-fio.jpg', FALSE, TRUE);

INSERT INTO cupons_desconto (codigo, desconto_percentual, data_validade, usos_maximos, ativo) VALUES
('PRIMEIRACOMPRA', 15.00, '2024-12-31', 1000, TRUE),
('PROMO10', 10.00, '2024-06-30', 500, TRUE),
('FRETEGRATIS', NULL, '2024-03-31', 200, TRUE),
('LANCAMENTO', 5.00, '2024-04-30', 300, TRUE);

INSERT INTO faq (pergunta, resposta, categoria, ordem) VALUES 
('Como faço para rastrear meu pedido?', 'Após a confirmação do pagamento, você receberá um código de rastreamento por email. Acesse "Meus Pedidos" para acompanhar.', 'entrega', 1),
('Qual o prazo de entrega?', 'O prazo varia de 3 a 10 dias úteis dependendo da sua localização. Para capitais, geralmente é mais rápido.', 'entrega', 2),
('Posso trocar ou devolver um produto?', 'Sim, aceitamos trocas e devoluções em até 7 dias após o recebimento, desde que o produto esteja em perfeito estado.', 'produto', 1),
('Quais formas de pagamento são aceitas?', 'Aceitamos cartão de crédito (até 12x), PIX (5% off) e boleto bancário.', 'pagamento', 1),
('O site é seguro para compras?', 'Sim, utilizamos certificado SSL e não armazenamos dados do seu cartão em nossos servidores.', 'compra', 1),
('Como funciona a garantia dos produtos?', 'Todos os produtos possuem garantia do fabricante, que varia de 3 a 12 meses. Consulte a nota fiscal.', 'garantia', 1),
('Preciso criar conta para comprar?', 'Não, você pode comprar como visitante, mas criar conta facilita o acompanhamento dos pedidos.', 'compra', 2);

INSERT INTO tickets_suporte (usuario_id, assunto, categoria, descricao, status, prioridade) VALUES
(2, 'Produto não chegou', 'entrega', 'Comprei um teclado há 15 dias e ainda não recebi. O código de rastreamento não atualiza.', 'aberto', 'alta'),
(2, 'Problema com garantia', 'garantia', 'Meu headset parou de funcionar após 2 meses de uso. Gostaria de acionar a garantia.', 'em_andamento', 'media');

INSERT INTO mensagens_suporte (ticket_id, usuario_id, mensagem, eh_admin) VALUES
(1, 2, 'Olá, comprei um teclado e ainda não recebi. Podem verificar?', FALSE),
(1, 1, 'Prezado cliente, verificamos seu pedido e identificamos um atraso na transportadora. Estamos acompanhando.', TRUE),
(2, 2, 'Meu headset HyperX parou de funcionar do nada. Como faço para acionar a garantia?', FALSE);

SELECT 'Banco de dados PGS Periféricos criado com sucesso!' as status;
